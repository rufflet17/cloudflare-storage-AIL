<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2 File Manager</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 2rem; background-color: #f4f4f5; color: #18181b; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1, h2 { margin-top: 0; }
        .auth-section, .main-section { display: flex; flex-direction: column; gap: 1rem; }
        .hidden { display: none; }
        input[type="password"], input[type="file"], button { width: 100%; padding: 0.75rem; border-radius: 4px; border: 1px solid #d4d4d8; font-size: 1rem; box-sizing: border-box; }
        button { background-color: #0070f3; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #005bb5; }
        button:disabled { background-color: #a1a1aa; cursor: not-allowed; }
        #file-list { list-style: none; padding: 0; }
        #file-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e4e4e7; }
        #file-list li:last-child { border-bottom: none; }
        .file-actions button { width: auto; padding: 0.3rem 0.8rem; font-size: 0.9rem; margin-left: 0.5rem; }
        #status { margin-top: 1rem; font-weight: bold; color: red; word-break: break-all; }
        .link-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 10px 15px rgba(0,0,0,0.2); z-index: 1000; border: 1px solid #d4d4d8; }
        .link-popup input { width: 100%; margin-bottom: 1rem; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    </style>
</head>
<body>
    <div class="container">
        <h1>R2 File Manager</h1>
        <div id="auth-section" class="auth-section">
            <p>アクセスするにはパスワードを入力してください。</p>
            <input type="password" id="password-input" placeholder="Password">
            <button id="login-button">ログイン</button>
            <p id="auth-status" style="color: red;"></p>
        </div>
        <div id="main-section" class="main-section hidden">
            <div>
                <h2>ファイルをアップロード</h2>
                <input type="file" id="file-input">
                <button id="upload-button" disabled>アップロード</button>
                <div id="status"></div>
            </div>
            <div>
                <h2>保存されているファイル</h2>
                <button id="refresh-button">リストを更新</button>
                <ul id="file-list"></ul>
            </div>
        </div>
    </div>
    <div id="popup-overlay" class="overlay hidden"></div>
    <div id="link-popup" class="link-popup hidden">
        <h3>永続ダウンロードリンク</h3>
        <input type="text" id="shareable-link" readonly>
        <button id="copy-link-button">クリップボードにコピー</button>
        <button id="close-popup-button">閉じる</button>
    </div>

    <script>
        const authSection = document.getElementById('auth-section');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const authStatus = document.getElementById('auth-status');
        const mainSection = document.getElementById('main-section');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const statusDiv = document.getElementById('status');
        const fileListUl = document.getElementById('file-list');
        const refreshButton = document.getElementById('refresh-button');
        const popupOverlay = document.getElementById('popup-overlay');
        const linkPopup = document.getElementById('link-popup');
        const shareableLinkInput = document.getElementById('shareable-link');
        const copyLinkButton = document.getElementById('copy-link-button');
        const closePopupButton = document.getElementById('close-popup-button');
        
        let authToken = null;

        async function apiCall(action, body) {
            const requestBody = { ...body, password: authToken, action: action };
            const response = await fetch(`/api/endpoint`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody) 
            });

            if (!response.ok) {
                const errorText = await response.text();
                if (response.status === 401) throw new Error('パスワードが間違っています。');
                if (response.status === 403) throw new Error('この環境からのAPIアクセスはブロックされています。');
                throw new Error(`APIエラー (ステータス: ${response.status}): ${errorText}`);
            }
            return response.json();
        }
        
        loginButton.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') handleLogin();
        });
        fileInput.addEventListener('change', () => uploadButton.disabled = fileInput.files.length === 0);
        uploadButton.addEventListener('click', handleUpload);
        refreshButton.addEventListener('click', fetchFileList);
        closePopupButton.addEventListener('click', () => {
            popupOverlay.classList.add('hidden');
            linkPopup.classList.add('hidden');
        });
        copyLinkButton.addEventListener('click', () => {
            shareableLinkInput.select();
            document.execCommand('copy');
            copyLinkButton.textContent = 'コピーしました！';
            setTimeout(() => { copyLinkButton.textContent = 'クリップボードにコピー'; }, 2000);
        });

        async function handleLogin() {
            const password = passwordInput.value;
            if (!password) {
                authStatus.textContent = 'パスワードを入力してください。';
                return;
            }
            authStatus.textContent = '認証中...';
            loginButton.disabled = true;
            authToken = password;
            try {
                await apiCall('list-files', {});
                authSection.classList.add('hidden');
                mainSection.classList.remove('hidden');
                fetchFileList();
            } catch (error) {
                authStatus.textContent = `エラー: ${error.message}`;
                authToken = null;
            } finally {
                loginButton.disabled = false;
            }
        }

        async function fetchFileList() {
            statusDiv.textContent = 'ファイルリストを読み込み中...';
            fileListUl.innerHTML = '';
            try {
                const { files } = await apiCall('list-files', {});
                if (files.length === 0) {
                    fileListUl.innerHTML = '<li>ファイルはありません。</li>';
                } else {
                    files.sort((a,b) => new Date(b.lastModified) - new Date(a.lastModified)).forEach(file => {
                        const li = document.createElement('li');
                        const fileNameSpan = document.createElement('span');
                        fileNameSpan.textContent = `${file.key} (${(file.size / 1024).toFixed(2)} KB)`;
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'file-actions';
                        const linkBtn = document.createElement('button');
                        linkBtn.textContent = 'リンク作成';
                        linkBtn.onclick = () => generateShareLink(file.key);
                        actionsDiv.appendChild(linkBtn);
                        li.appendChild(fileNameSpan);
                        li.appendChild(actionsDiv);
                        fileListUl.appendChild(li);
                    });
                }
                statusDiv.textContent = '';
            } catch (error) {
                statusDiv.textContent = `エラー: ${error.message}`;
            }
        }

        async function handleUpload() {
            const file = fileInput.files[0];
            if (!file) return;
            statusDiv.textContent = 'アップロード用URLをリクエスト中...';
            uploadButton.disabled = true;
            try {
                const { url } = await apiCall('generate-upload-url', { filename: file.name, contentType: file.type || 'application/octet-stream' });
                statusDiv.textContent = 'ファイルをアップロード中...';
                const uploadResponse = await fetch(url, { method: 'PUT', body: file, headers: { 'Content-Type': file.type || 'application/octet-stream' } });
                
                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    throw new Error(`アップロードに失敗しました。ステータス: ${uploadResponse.status}, R2からの応答: ${errorText}`);
                }
                statusDiv.textContent = 'アップロードが完了しました！';
                fileInput.value = '';
                await fetchFileList();
            } catch (error) {
                statusDiv.textContent = `エラー: ${error.message}`;
            } finally {
                uploadButton.disabled = false;
            }
        }
        
        function generateShareLink(filename) {
            // ベースURLを固定の本番サイトURLに変更
            const productionUrl = 'https://download.pages.dev';
            const permanentLink = `${productionUrl}/api/${encodeURIComponent(filename)}`;
            
            shareableLinkInput.value = permanentLink;
            popupOverlay.classList.remove('hidden');
            linkPopup.classList.remove('hidden');
            statusDiv.textContent = '';
        }
    </script>
</body>
</html>